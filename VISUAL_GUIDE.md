# Визуальное руководство по мультирегиональному обнаружению линии

## Схема разделения изображения на регионы

```
┌─────────────────────────────────────────────────┐
│                                                 │
│              Область не сканируется             │ ← 0% - 16.7% высоты
│                                                 │
├─────────────────────────────────────────────────┤
│  ████████████ ВЕРХНИЙ РЕГИОН █████████████████  │ ← 16.7% - 33.3%
│  │                                            │  │   (Дальняя зона)
│  │  Линия здесь: lineCenterTop = X1          │  │
│  │                                            │  │   Детекция поворота
│  └────────────────────────────────────────────┘  │   заранее
│                                                 │
├─────────────────────────────────────────────────┤
│  ▓▓▓▓▓▓▓▓▓▓▓▓ СРЕДНИЙ РЕГИОН ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓  │ ← 33.3% - 66.7%
│  │                                            │  │   (Основная зона)
│  │  Линия здесь: lineCenterMiddle = X2       │  │
│  │                                            │  │   Стабильная
│  └────────────────────────────────────────────┘  │   детекция
│                                                 │
├─────────────────────────────────────────────────┤
│  ░░░░░░░░░░░░ НИЖНИЙ РЕГИОН ░░░░░░░░░░░░░░░░░░  │ ← 66.7% - 83.3%
│  │                                            │  │   (Ближняя зона)
│  │  Линия здесь: lineCenterBottom = X3       │  │
│  │                                            │  │   Наиболее
│  └────────────────────────────────────────────┘  │   надежная
│                                                 │
├─────────────────────────────────────────────────┤
│                                                 │
│              Область не сканируется             │ ← 83.3% - 100%
│                                                 │
└─────────────────────────────────────────────────┘
```

## Примеры детекции разных типов линий

### 1. Прямая линия

```
┌─────────────────────────────────────────────────┐
│                     │                           │
│  ████████████      │      █████████████████     │
│  │                 │                       │     │
│  │   lineCenterTop = 160 (центр)          │     │
│  │                 │                       │     │
│  └─────────────────│───────────────────────┘     │
│                     │                           │
│  ▓▓▓▓▓▓▓▓▓▓▓▓      │      ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓     │
│  │                 │                       │     │
│  │   lineCenterMiddle = 160 (центр)       │     │
│  │                 │                       │     │
│  └─────────────────│───────────────────────┘     │
│                     │                           │
│  ░░░░░░░░░░░░      │      ░░░░░░░░░░░░░░░░░     │
│  │                 │                       │     │
│  │   lineCenterBottom = 160 (центр)       │     │
│  │                 │                       │     │
│  └─────────────────│───────────────────────┘     │
│                     │                           │
└─────────────────────────────────────────────────┘

Расчет:
displacement = (X3 - X2) + (X2 - X1) + (X3 - X1)*0.5
             = (160-160) + (160-160) + (160-160)*0.5 = 0
curveAngle = atan(0 / verticalDistance) * 180/π = 0°
turnDirection = "straight"
```

### 2. Плавный поворот влево

```
┌─────────────────────────────────────────────────┐
│                          │                      │
│  ████████████           │       ████████████    │
│  │                      │                  │    │
│  │   lineCenterTop = 185 (смещено вправо)  │    │
│  │                      │                  │    │
│  └──────────────────────│──────────────────┘    │
│                          │                      │
│  ▓▓▓▓▓▓▓▓▓▓▓▓           │   ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓     │
│  │                      │                  │    │
│  │   lineCenterMiddle = 170 (немного правее)│   │
│  │                      │                  │    │
│  └──────────────────────│──────────────────┘    │
│                          │                      │
│  ░░░░░░░░░░░░       │       ░░░░░░░░░░░░░░░     │
│  │                │                         │    │
│  │   lineCenterBottom = 150 (левее центра) │    │
│  │                │                         │    │
│  └────────────────│─────────────────────────┘    │
│                   │                              │
└─────────────────────────────────────────────────┘
            │
            └─→ Линия изгибается влево

Расчет:
displacement = (150-170) + (170-185) + (150-185)*0.5
             = (-20) + (-15) + (-17.5) = -52.5
curveAngle = atan(-52.5 / 128) * 180/π ≈ -22.3°
turnDirection = "left"
sharpTurnDetected = false (угол < 30°)
```

### 3. Резкий поворот вправо (90°)

```
┌─────────────────────────────────────────────────┐
│           │                                     │
│  ████████████          ████████████             │
│  │        │                       │             │
│  │   lineCenterTop = 100 (сильно левее)  │     │
│  │        │                       │             │
│  └────────│───────────────────────┘             │
│           │                                     │
│  ▓▓▓▓▓▓▓▓▓▓▓▓              ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓     │
│  │              │                         │     │
│  │   lineCenterMiddle = 150 (центральнее)│     │
│  │              │                         │     │
│  └──────────────│─────────────────────────┘     │
│                 │                               │
│  ░░░░░░░░░░░░                  ░░░░░░░░░░░░░░  │
│  │                                          │   │
│  │   lineCenterBottom = 220 (сильно правее)│   │
│  │                                          │   │
│  └──────────────────────────────────────────┘   │
│                                   │             │
└───────────────────────────────────│─────────────┘
                                    │
                                    └─→ Резкий поворот вправо

Расчет:
displacement = (220-150) + (150-100) + (220-100)*0.5
             = 70 + 50 + 60 = 180
curveAngle = atan(180 / 128) * 180/π ≈ 54.6°
turnDirection = "right"
sharpTurnDetected = true (угол > 30°)
```

### 4. S-образная кривая (начало)

```
┌─────────────────────────────────────────────────┐
│                              │                  │
│  ████████████               │   █████████████   │
│  │                          │              │    │
│  │   lineCenterTop = 195 (правее)         │    │
│  │                          │              │    │
│  └──────────────────────────│──────────────┘    │
│                              │                  │
│  ▓▓▓▓▓▓▓▓▓▓▓▓                │  ▓▓▓▓▓▓▓▓▓▓▓▓    │
│  │                           │             │    │
│  │   lineCenterMiddle = 160 (центр)       │    │
│  │                           │             │    │
│  └───────────────────────────│─────────────┘    │
│                               │                 │
│  ░░░░░░░░░░░░      │      ░░░░░░░░░░░░░░░░      │
│  │               │                        │     │
│  │   lineCenterBottom = 130 (левее)      │     │
│  │               │                        │     │
│  └───────────────│────────────────────────┘     │
│                  │                              │
└──────────────────────────────────────────────────┘
         │
         └─→ Начало поворота влево в S-кривой

Расчет:
displacement = (130-160) + (160-195) + (130-195)*0.5
             = (-30) + (-35) + (-32.5) = -97.5
curveAngle = atan(-97.5 / 128) * 180/π ≈ -37.3°
turnDirection = "left"
sharpTurnDetected = true (может быть резким)
```

## Визуализация на изображении камеры

### Индикаторы детекции

```
Видео с камеры (обработанное 1-битное изображение):

┌─────────────────────────────────────────────────┐
│▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒  ·  ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒│ ← Верхняя граница
│▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒  ·  ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒│   ВЕРХНИЙ РЕГИОН
│▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒  ·  ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒│   Тонкая линия (1px)
│▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒  ·  ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒│
│▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒  ·  ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒│
├─────────────────────────────────────────────────┤
│▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒  ···  ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒│ ← Средняя граница
│▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒  ···  ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒│   СРЕДНИЙ РЕГИОН
│▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒  ···  ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒│   Средняя линия (3px)
│▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒  ···  ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒│
│▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒  ···  ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒│
├─────────────────────────────────────────────────┤
│▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒  █████  ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒│ ← Нижняя граница
│▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒  █████  ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒│   НИЖНИЙ РЕГИОН
│▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒  █████  ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒│   Толстая линия (5px)
│▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒  █████  ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒│
└─────────────────────────────────────────────────┘

Легенда:
▒▒▒  = Белое поле
     = Черная линия (детектируется)
·    = Индикатор верхнего региона (тонкая линия)
···  = Индикатор среднего региона (средняя линия)
████ = Индикатор нижнего региона (толстая линия)
```

### Соединительная линия для кривых

При обнаружении поворота между регионами рисуется соединительная линия:

```
Прямая линия:                     Изгиб влево:
┌──────────────┐                  ┌──────────────┐
│      ·       │                  │         ·    │
│      ·       │                  │        ⋰     │
│      ·       │                  │       ⋰      │
│      ·       │                  │      ⋰       │
│      ·       │                  │     ⋰        │
│     ···      │                  │   ⋰⋰⋰        │
│     ···      │                  │  ⋰⋰⋰         │
│     ███      │                  │ ███          │
│     ███      │                  │ ███          │
└──────────────┘                  └──────────────┘
   Угол ≈ 0°                      Угол ≈ -25°
```

## Алгоритм обработки

```
┌─────────────────────────────────────────────────────────┐
│                    НАЧАЛО ЦИКЛА                         │
└────────────────────────┬────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│         1. Захват кадра с камеры (GRAYSCALE)            │
│            320x240 пикселей, 8-бит оттенки серого       │
└────────────────────────┬────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│         2. Конвертация в 1-бит (бинаризация)            │
│            Каждый пиксель: < threshold → 0, ≥ → 255     │
└────────────────────────┬────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│         3. Сканирование ВЕРХНЕГО региона                │
│            Строки: height/6 до height/3                 │
│            → lineCenterTop                              │
└────────────────────────┬────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│         4. Сканирование СРЕДНЕГО региона                │
│            Строки: height/3 до 2*height/3               │
│            → lineCenterMiddle                           │
└────────────────────────┬────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│         5. Сканирование НИЖНЕГО региона                 │
│            Строки: 2*height/3 до 5*height/6             │
│            → lineCenterBottom                           │
└────────────────────────┬────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│         6. Определение основной позиции                 │
│            Приоритет: Bottom → Middle → Top             │
│            → lineCenterX                                │
└────────────────────────┬────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│         7. Расчет смещения и угла поворота              │
│            displacement = (B-M) + (M-T) + (B-T)*0.5     │
│            curveAngle = atan(disp / vertDist) * 180/π   │
└────────────────────────┬────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│         8. Определение направления поворота             │
│            |displacement| < 5% → "straight"             │
│            displacement > 0   → "right"                 │
│            displacement < 0   → "left"                  │
└────────────────────────┬────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│         9. Определение резкости поворота                │
│            |curveAngle| > 30° → sharpTurnDetected       │
└────────────────────────┬────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│         10. Визуализация на изображении                 │
│             - Индикаторы регионов                       │
│             - Соединительная линия                      │
└────────────────────────┬────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│         11. Отправка данных                             │
│             - JSON через /status API                    │
│             - Изображение через /stream                 │
└────────────────────────┬────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│                   КОНЕЦ ЦИКЛА                           │
│              (Повтор через ~100 мс)                     │
└─────────────────────────────────────────────────────────┘
```

## Примеры использования в коде робота

### Пример 1: Базовое использование

```cpp
// Получить кадр и детектировать
camera_fb_t * fb = esp_camera_fb_get();
detectLineMultiRegion(fb);
esp_camera_fb_return(fb);

// Определить основную позицию
int mainPosition = lineCenterBottom >= 0 ? lineCenterBottom : 
                   (lineCenterMiddle >= 0 ? lineCenterMiddle : lineCenterTop);

// Вычислить ошибку для PID
float error = (mainPosition - imageWidth/2) * 100.0 / imageWidth;

// Проверить тип поворота
if (sharpTurnDetected) {
    Serial.println("РЕЗКИЙ ПОВОРОТ!");
}
```

### Пример 2: Адаптивное управление

```cpp
// Базовые коэффициенты PID
float baseKp = 2.0;
float baseKd = 1.0;

// Адаптировать коэффициенты на основе поворота
float adaptiveKp = baseKp;
float adaptiveKd = baseKd;

if (sharpTurnDetected) {
    // Резкий поворот - увеличить отклик
    adaptiveKp *= 1.5;
    adaptiveKd *= 1.2;
    baseSpeed *= 0.7;  // Замедлить на резких поворотах
} else if (fabs(curveAngle) > 10) {
    // Плавный поворот - немного увеличить
    adaptiveKp *= 1.2;
    adaptiveKd *= 1.1;
}

// Применить PID с адаптированными коэффициентами
float control = calculatePID(error, adaptiveKp, adaptiveKd);
```

### Пример 3: Упреждающее управление

```cpp
// Использовать верхний регион для прогнозирования
if (lineCenterTop >= 0 && lineCenterBottom >= 0) {
    // Вычислить упреждающую ошибку
    float anticipatedError = (lineCenterTop - imageWidth/2) * 0.2;
    
    // Добавить к текущей ошибке
    error += anticipatedError;
    
    // Начать поворот раньше для плавного прохождения
    if (fabs(curveAngle) > 20) {
        Serial.println("Начинаю поворот заранее...");
    }
}
```

## Заключение

Мультирегиональное обнаружение линии обеспечивает:

1. **Раннее предупреждение** - видим поворот до того, как доедем до него
2. **Точный расчет** - измеряем угол поворота в градусах
3. **Надежность** - три точки обнаружения вместо одной
4. **Визуальная обратная связь** - видим, что "видит" робот
5. **Адаптивность** - можем менять стратегию в зависимости от типа поворота

Эта система делает робота способным следовать по комплексным траекториям с комбинацией прямых участков, плавных изгибов и резких поворотов.
