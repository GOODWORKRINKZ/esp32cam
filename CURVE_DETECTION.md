# Обнаружение поворотов и кривых линий

## Обзор

Система обнаружения линии ESP32-CAM теперь поддерживает детектирование как резких поворотов на 90 градусов, так и плавных изгибов траектории. Это достигается путем сканирования нескольких областей изображения и анализа положения линии в каждой из них.

## Принцип работы

### Мультирегиональное сканирование

Изображение делится на три горизонтальных региона:

1. **Верхний регион** (1/6 - 1/3 высоты изображения)
   - Дальняя зона обзора
   - Позволяет заблаговременно обнаружить предстоящий поворот
   - Используется для прогнозирования траектории

2. **Средний регион** (1/3 - 2/3 высоты изображения)
   - Основная зона обнаружения
   - Стабильная детекция линии
   - Балансирует между дальностью и точностью

3. **Нижний регион** (2/3 - 5/6 высоты изображения)
   - Ближняя зона (непосредственно перед роботом)
   - Наиболее надежная детекция
   - Основная для управления движением

### Алгоритм определения поворота

#### Расчет угла поворота

```cpp
// Горизонтальное смещение между регионами
displacement = lineCenterBottom - lineCenterTop;

// Вертикальное расстояние между регионами (приблизительно)
verticalDistance = imageWidth * 0.4;

// Угол наклона линии
curveAngle = atan(displacement / verticalDistance) * 180 / π;
```

#### Классификация поворотов

| Угол | Тип поворота | Описание |
|------|--------------|----------|
| < 5° | Прямая линия | Почти прямая траектория |
| 5° - 30° | Плавный поворот | Требуется коррекция направления |
| > 30° | Резкий поворот | Крутой поворот, требует значительной коррекции |

### Направление поворота

Система определяет три возможных направления:

- **"straight"** - прямая линия (смещение < 5% ширины изображения)
- **"left"** - поворот влево (линия смещается влево)
- **"right"** - поворот вправо (линия смещается вправо)

## Визуализация

В веб-интерфейсе отображаются:

1. **Индикаторы позиции в каждом регионе**
   - Верхний регион: тонкая линия (1 пиксель толщиной)
   - Средний регион: средняя линия (3 пикселя)
   - Нижний регион: толстая линия (5 пикселей)

2. **Соединительная линия** между верхним и нижним регионами
   - Визуализирует траекторию изгиба
   - Помогает оценить крутизну поворота

3. **Информация в веб-интерфейсе**
   - Направление поворота (⬅️ влево / ➡️ вправо / прямо)
   - Угол поворота в градусах
   - Индикатор резкого поворота

## Использование для управления роботом

### Базовая интеграция

```cpp
// Получить данные о линии и повороте
detectLineMultiRegion(fb);

// Основная позиция (приоритет: нижний -> средний -> верхний)
int mainPosition = lineCenterBottom >= 0 ? lineCenterBottom : 
                   (lineCenterMiddle >= 0 ? lineCenterMiddle : lineCenterTop);

// Используйте curveAngle для адаптации управления
if (sharpTurnDetected) {
    // Увеличить коэффициенты PID для резкого поворота
    // Уменьшить базовую скорость
}
```

### Адаптивное PID управление

Пример из `motor_control_integration.ino`:

```cpp
float currentKp = Kp;
float currentKd = Kd;

if (sharpTurnDetected) {
    // Резкий поворот - увеличить отклик
    currentKp = Kp * 1.5;
    currentKd = Kd * 1.2;
} else if (abs(curveAngle) > 10) {
    // Плавный поворот - умеренное увеличение
    currentKp = Kp * 1.2;
    currentKd = Kd * 1.1;
}

float control = calculatePID(error, currentKp, currentKd);
```

### Упреждающее управление

```cpp
// Используйте линию в верхнем регионе для прогнозирования
if (lineCenterTop >= 0 && abs(curveAngle) > 20) {
    // Начать поворот заранее для плавного прохождения
    float anticipatedError = (lineCenterTop - imageWidth/2) * 0.3;
    error += anticipatedError;
}
```

## Оптимизация производительности

### Частота сканирования

- **Нижний регион**: сканируется каждые 3 строки (высокая точность)
- **Средний регион**: сканируется каждые 3 строки
- **Верхний регион**: сканируется каждые 3 строки

### Время обработки

- Сканирование одного региона: ~10-15 мс
- Полное обнаружение (3 региона + анализ): ~40-50 мс
- Общая частота кадров с визуализацией: ~8-10 FPS

## Преимущества мультирегионального подхода

### 1. Раннее обнаружение поворотов

- Робот видит поворот до того, как достигнет его
- Время для плавного замедления и подготовки
- Уменьшение риска потери линии

### 2. Устойчивость к помехам

- Несколько точек детекции повышают надежность
- Если один регион теряет линию, используются другие
- Снижение ложных срабатываний

### 3. Точное определение кривизны

- Измерение изменения позиции на расстоянии
- Более точный расчет необходимого угла поворота
- Адаптивное управление в зависимости от крутизны

### 4. Различение типов поворотов

- Плавные повороты: постепенное изменение позиции
- Резкие повороты: большое смещение между регионами
- Прямые участки: минимальное изменение

## Тестирование

### Тестовые сценарии

1. **Прямая линия**
   - Все три региона показывают примерно одинаковую позицию
   - `curveAngle` близок к 0°
   - `turnDirection` = "straight"

2. **Плавный поворот (S-образная кривая)**
   - Постепенное изменение позиции между регионами
   - `curveAngle` 5° - 30°
   - `sharpTurnDetected` = false

3. **Резкий поворот 90°**
   - Большое смещение между верхним и нижним регионами
   - `curveAngle` > 30°
   - `sharpTurnDetected` = true

4. **Серия поворотов**
   - Система успевает детектировать каждый поворот
   - Плавный переход между направлениями

### Калибровка

1. Поместите робота на прямой участок
2. Убедитесь, что `curveAngle` ≈ 0°
3. Проверьте детекцию во всех трех регионах
4. Проведите тест на повороте известной крутизны
5. Подстройте пороговые значения при необходимости

## Настройка параметров

### Пороги детекции поворота

В `main.cpp`:

```cpp
// Порог для резкого поворота (в градусах)
#define SHARP_TURN_THRESHOLD 30.0

// Порог для прямой линии (в процентах от ширины)
#define STRAIGHT_THRESHOLD 5.0
```

### Веса регионов

Приоритет регионов при определении основной позиции:

1. Нижний (наивысший приоритет) - самый надежный
2. Средний - запасной вариант
3. Верхний (низкий приоритет) - только для прогнозирования

### Адаптация под условия трассы

**Для широких поворотов:**
- Уменьшите `SHARP_TURN_THRESHOLD` до 20-25°
- Увеличьте влияние верхнего региона

**Для узких технических трасс:**
- Увеличьте `SHARP_TURN_THRESHOLD` до 35-40°
- Больше доверяйте нижнему региону

**Для высокоскоростного движения:**
- Увеличьте вес верхнего региона
- Начинайте маневры раньше

## API и переменные

### Глобальные переменные

```cpp
int lineCenterTop = -1;        // Позиция в верхнем регионе (-1 = не обнаружена)
int lineCenterMiddle = -1;     // Позиция в среднем регионе
int lineCenterBottom = -1;     // Позиция в нижнем регионе
float curveAngle = 0.0;        // Угол поворота в градусах
bool sharpTurnDetected = false; // true если угол > 30°
String turnDirection = "straight"; // "left", "right", "straight"
```

### Основные функции

```cpp
// Обнаружение линии в конкретном регионе
void detectLineCenterInRegion(uint8_t* buf, int width, int height, 
                               int startRow, int endRow, int& centerX);

// Полное обнаружение с анализом кривизны
void detectLineCenter(uint8_t* buf, int width, int height);

// Анализ поворота и кривизны
void detectCurveAndTurn(int width);
```

### JSON API (веб-интерфейс)

```json
{
  "lineDetected": true,
  "lineCenterX": 160,
  "lineCenterTop": 165,
  "lineCenterMiddle": 162,
  "lineCenterBottom": 158,
  "curveAngle": -4.5,
  "sharpTurn": false,
  "turnDirection": "left"
}
```

## Известные ограничения

1. **Разрывы линии**: Если линия прерывается в одном регионе, используются данные других регионов
2. **Очень крутые повороты (> 70°)**: Линия может выйти за пределы видимости верхнего региона
3. **Пересечения**: Система детектирует только одну линию в каждом регионе
4. **Производительность**: Тройное сканирование занимает больше времени, чем одинарное

## Будущие улучшения

- [ ] Адаптивное изменение областей сканирования в зависимости от обнаруженного угла
- [ ] Прогнозирование траектории на основе истории детекции
- [ ] Детекция типа поворота (постоянный радиус vs переменный)
- [ ] Обнаружение специальных маркеров (перекрестки, развилки)

## Заключение

Мультирегиональное обнаружение линии значительно улучшает способность робота справляться с различными типами траекторий:

- ✅ Резкие повороты 90° обнаруживаются заранее
- ✅ Плавные изгибы точно отслеживаются
- ✅ Адаптивное управление в зависимости от крутизны
- ✅ Визуальная обратная связь для отладки

Эта функция делает ESP32-CAM идеальным выбором для соревнований по следованию за линией с комплексными трассами.
